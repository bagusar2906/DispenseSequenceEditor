<UserControl x:Class="RMIDispenseSequenceEditor.Views.DispenseSequenceEditorControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:RMIDispenseSequenceEditor.Views"
             mc:Ignorable="d">

    <Grid Margin="10">

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />  <!-- Source Ingredient List -->
            <RowDefinition Height="10" />
            <RowDefinition Height="*" />     <!-- Destination Rows -->
        </Grid.RowDefinitions>


        <!-- ======================================================
             SOURCE INGREDIENT LIST (TOP)
        ======================================================= -->
        <StackPanel Grid.Row="0">

            <TextBlock Text="Ingredients"
                       FontWeight="Bold"
                       Margin="0 0 0 10" />

            <ItemsControl ItemsSource="{Binding Ingredients}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"
                                   ItemWidth="120"
                                   ItemHeight="70" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <local:ChipControl
                            IsFromSource="True"
                            Text="{Binding}"
                            Margin="0 6 6 0">
                            <local:ChipControl.Style>
                                <Style TargetType="local:ChipControl">
                                    <EventSetter Event="PreviewMouseMove"
                                                 Handler="SourceChip_PreviewMouseMove" />
                                </Style>
                            </local:ChipControl.Style>
                        </local:ChipControl>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

        </StackPanel>


        <!-- ======================================================
             DESTINATION ROWS (BOTTOM)
        ======================================================= -->
        <ScrollViewer Grid.Row="2"
                      VerticalScrollBarVisibility="Auto">

            <ItemsControl ItemsSource="{Binding Slots}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>

                        <StackPanel Orientation="Vertical"
                                    Margin="0 10 0 0">


                            <!-- ======================================================
                                 ONE HORIZONTAL LINE: DRAG HANDLE + ROW INDEX + DROP AREA
                            ======================================================= -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="30" />   <!-- Drag handle -->
                                    <ColumnDefinition Width="30" />   <!-- Row index -->
                                    <ColumnDefinition Width="*" />    <!-- Drop Area -->
                                </Grid.ColumnDefinitions>

                                <!-- Drag Handle -->
                                <Grid Grid.Column="0"
                                      Width="24" Height="24"
                                      Cursor="SizeAll"
                                      Margin="0 0 6 0">
                                    <Grid Background="Transparent" />
                                    <TextBlock Text="⋮⋮"
                                               FontSize="18"
                                               Foreground="#777"
                                               HorizontalAlignment="Center"/>
                                </Grid>

                                <!-- Row Index -->
                                <TextBlock Grid.Column="1"
                                           Text="{Binding SlotIndex}"
                                           VerticalAlignment="Center"
                                           FontSize="14" />


                                <!-- ================= DROP AREA (INLINE) ================= -->
                                <Grid Grid.Column="2"
                                      Height="60"
                                      Margin="2 0 0 0"
                                      AllowDrop="True"
                                      Tag="{Binding SlotIndex}">

                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <!-- Dashed Border -->
                                    <Rectangle Stroke="#888"
                                               StrokeThickness="1"
                                               StrokeDashArray="3 3"
                                               Width="400"
                                               Fill="#04FFFFFF"
                                               RadiusX="6"
                                               RadiusY="6" />

                                    <!-- Chips inside -->
                                    <ItemsControl Grid.Column="0"
                                                  ItemsSource="{Binding Chips}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <StackPanel Orientation="Horizontal"
                                                            VerticalAlignment="Center"
                                                            Margin="10 0" />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>

                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <local:ChipControl
                                                    IsFromSource="False"
                                                    Text="{Binding}"
                                                    Margin="0 0 8 0">
                                                    <local:ChipControl.Style>
                                                        <Style TargetType="local:ChipControl">
                                                            <EventSetter Event="PreviewMouseMove"
                                                                         Handler="SlotChip_PreviewMouseMove" />
                                                        </Style>
                                                    </local:ChipControl.Style>
                                                </local:ChipControl>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!-- Placeholder -->
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding PlaceholderText}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"
                                               Foreground="#777"
                                               FontStyle="Italic"
                                               IsHitTestVisible="False" />

                                    <!-- Drag-drop handlers -->
                                    <Grid.Style>
                                        <Style TargetType="Grid">
                                            <EventSetter Event="DragEnter" Handler="RowPlaceholder_DragEnter" />
                                            <EventSetter Event="DragLeave" Handler="RowPlaceholder_DragLeave" />
                                            <EventSetter Event="DragOver" Handler="RowPlaceholder_DragOver" />
                                            <EventSetter Event="Drop" Handler="RowPlaceholder_Drop" />
                                        </Style>
                                    </Grid.Style>

                                </Grid>

                            </Grid>


                            <!-- ===============================================
                                 MODE SELECTION BELOW
                            ================================================ -->
                            <StackPanel Orientation="Horizontal" Margin="60,8,0,5">

                                <RadioButton Content="Normal"
                                             Margin="0,0,16,0"
                                             GroupName="{Binding StepIndex}"
                                             IsChecked="{Binding IsNormal}" />

                                <RadioButton Content="Batch"
                                             Margin="0,0,16,0"
                                             GroupName="{Binding StepIndex}"
                                             IsChecked="{Binding IsBatch}" />

                                <RadioButton Content="Aliquoting"
                                             GroupName="{Binding StepIndex}"
                                             IsChecked="{Binding IsAliquoting}" />

                            </StackPanel>

                        </StackPanel>

                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

        </ScrollViewer>

    </Grid>
</UserControl>