<UserControl x:Class="RMIDispenseSequenceEditor.Views.DispenseSequenceEditorControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:RMIDispenseSequenceEditor.Views"
             mc:Ignorable="d">


    <Grid Margin="10">

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Source Ingredient List -->
            <RowDefinition Height="10"/>
            <RowDefinition Height="*"/>     <!-- Destination Rows -->
        </Grid.RowDefinitions>


        <!-- ======================================================
             SOURCE INGREDIENT LIST (TOP)
        ======================================================= -->
        <StackPanel Grid.Row="0">

            <TextBlock Text="Ingredients"
                       FontWeight="Bold"
                       Margin="0 0 0 10" />

            <ItemsControl ItemsSource="{Binding Ingredients}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"
                                   ItemWidth="120"
                                   ItemHeight="70"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <local:ChipControl
                            IsFromSource="True"
                            Text="{Binding}"
                                           Margin="0 6 6 0">
                            <local:ChipControl.Style>
                                <Style TargetType="local:ChipControl">
                                    <EventSetter Event="PreviewMouseMove"
                                                 Handler="SourceChip_PreviewMouseMove"/>
                                </Style>
                            </local:ChipControl.Style>
                        </local:ChipControl>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

        </StackPanel>



        <!-- ======================================================
             DESTINATION ROWS (BOTTOM)
        ======================================================= -->
        <ScrollViewer Grid.Row="2"
                      VerticalScrollBarVisibility="Auto">

            <ItemsControl ItemsSource="{Binding Slots}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>

                        <StackPanel Orientation="Vertical"
                                    Margin="0 10 0 0">


                            <!-- ===============================================
                                 ROW HEADER: DRAG HANDLE + ROW INDEX
                            ================================================ -->
                            <StackPanel Orientation="Horizontal"
                                        VerticalAlignment="Center"
                                        Margin="0 0 0 5">

                                <!-- Drag Handle -->
                                <Grid Width="24" Height="24"
                                      Margin="0 0 6 0"
                                      Cursor="SizeAll">
                                    <Grid Background="Transparent"/>
                                    <TextBlock Text="≡"
                                               FontSize="18"
                                               FontWeight="Bold"
                                               VerticalAlignment="Center"
                                               HorizontalAlignment="Center"/>
                                </Grid>

                                <!-- Row Index -->
                                <TextBlock Text="{Binding SlotIndex, StringFormat=Row {0}}"
                                           FontWeight="Bold"
                                           VerticalAlignment="Center"
                                           FontSize="16"/>
                            </StackPanel>



                            <!-- ===============================================
                                 DROP BORDER THAT HOLDS CHIPS INSIDE
                            ================================================ -->
                            <Grid Margin="0 8 0 0"
                                  Height="70"
                                  AllowDrop="True"
                                  Tag="{Binding SlotIndex}">

                                <!-- Dashed Border -->
                                <Rectangle Stroke="#888"
                                           StrokeThickness="2"
                                           StrokeDashArray="4 4"
                                           Fill="#04FFFFFF"
                                           RadiusX="6"
                                           RadiusY="6"/>

                                <!-- Chips inside border -->
                                <ItemsControl ItemsSource="{Binding Chips}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Orientation="Horizontal"
                                                        VerticalAlignment="Center"
                                                        Margin="10 0"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>

                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <local:ChipControl
                                                IsFromSource="False"
                                                Text="{Binding}"
                                                               Margin="0 0 8 0">
                                                <local:ChipControl.Style>
                                                    <Style TargetType="local:ChipControl">
                                                        <EventSetter Event="PreviewMouseMove"
                                                                     Handler="SlotChip_PreviewMouseMove"/>
                                                    </Style>
                                                </local:ChipControl.Style>
                                            </local:ChipControl>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <!-- Placeholder when empty -->
                                <TextBlock Text="{Binding PlaceholderText}"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           Foreground="#777"
                                           FontStyle="Italic"
                                           IsHitTestVisible="False" />

                                <!-- Drop Event Handlers -->
                                <Grid.Style>
                                    <Style TargetType="Grid">
                                        <EventSetter Event="DragEnter" Handler="RowPlaceholder_DragEnter"/>
                                        <EventSetter Event="DragLeave" Handler="RowPlaceholder_DragLeave"/>
                                        <EventSetter Event="DragOver"  Handler="RowPlaceholder_DragOver"/>
                                        <EventSetter Event="Drop"      Handler="RowPlaceholder_Drop"/>
                                    </Style>
                                </Grid.Style>

                            </Grid>



                            <!-- ===============================================
                                 MODE SELECTION BELOW ROW
                            ================================================ -->
                            <StackPanel Orientation="Horizontal"
                                        Margin="0 8 0 0">

                                <TextBlock Text="Mode:"
                                           VerticalAlignment="Center"
                                           Margin="0 0 8 0"/>

                                <ComboBox Width="130"
                                          SelectedItem="{Binding Mode}">
                                    <ComboBoxItem Content="Normal"/>
                                    <ComboBoxItem Content="Parallel"/>
                                    <ComboBoxItem Content="Repeat"/>
                                    <ComboBoxItem Content="Wait"/>
                                </ComboBox>
                            </StackPanel>

                        </StackPanel>

                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

        </ScrollViewer>


    </Grid>
</UserControl>

